define(["app"],function(a){a.filter("myFilter",[function(){return function(a,b){var c=[];return a.map(function(a,d){a.cat.search(new RegExp(b,"gi"))>-1&&c.push(a)}),c}}]),a.directive("selectbox",["$sce","$http","$compile","$filter","$document",function(a,b,c,d,e){var f=function(a,c,d){c.showloading=!0,b({url:c.apiAddress,method:"GET",params:{q:a}}).success(function(b){d&&angular.forEach(b.extra,function(c,d){var e=c.cat.indexOf(a),f=c.cat.insert(e,"<strong>");e=f.indexOf(a);var f=f.insert(e+a.length,"</strong>");b.extra[d].cat=f}),c.showloading=!1,c.cats=b.extra})};return{transclude:!0,scope:{options:"=",initialOpen:"@",apiAddress:"@",searchPlaceholder:"@",selectedObjectArray:"=selectedObjectArray",initialSearchApi:"@"},controller:["$scope","$element","$attrs","$transclude",function(a,b,e,g){function h(b,c){a.cats.push({_id:"id_"+b,cat:c}),m.push({_id:"id_"+b,cat:c})}var i=!1;a.title=e.title,a.searchPlaceholder||(a.searchPlaceholder="Start typing ..."),a.status={isopen:!1},a.dropdown=function(){a.status.isopen=!a.status.isopen};var j=d("myFilter"),k=[],l=!1;a.cats=[];var m=[];a.q="",a.showloading=!1;var n,o,p,q,r=0,s=0,t=[];if("true"==a.initialOpen&&(a.status.isopen=!0),void 0!=e.multiple&&(l=!0),!a.apiAddress){if(a.options)if("object"==typeof a.options[0]){var u;for(var v in a.options[0]){u=v;break}for(var w=0;w<a.options.length;w++)h(u,a.options[w][u])}else for(var w=0;w<a.options.length;w++)h(w,a.options[w]);g(function(a,b){angular.forEach(a,function(a,b){""!=a&&"option"===a.nodeName.toLowerCase()&&(i=!0,h(a.value,a.innerHTML))})})}a.remove=function(b,d){return d.stopPropagation(),a.selectedObjectArray.forEach(function(c,d){b===c._id&&(a.cats.push(c),a.selectedObjectArray.splice(d,1))}),angular.element(document.querySelector("span#item_"+b)).remove(),q=o[0].offsetWidth,t.length>0&&p-300>q&&($el='<span id="item_'+t[0]._id+'" class="tag">'+t[0].cat+'<span ng-click=remove("'+t[0]._id+'",$event) class="remove"> x </span></span>',o.prepend(c($el)(a)),t.splice(0,1),s--,r++,s>0?angular.element(document.querySelector("span#notAddedTags")).html(" "+s+" more selected"):angular.element(document.querySelector("span#notAddedTags")).remove()),0===a.selectedObjectArray.length&&(a.title=e.title),!1},a.addItem=function(b){void 0===n&&(n=angular.element(document.querySelector("div.togglerdiv")),p=n[0].offsetWidth),void 0===o&&(o=angular.element(document.querySelector("div.tagsWrapper"))),q=o[0].offsetWidth,l?(a.selectedObjectArray.push(b),p-300>q?(r++,$el=c('<span id="item_'+b._id+'" class="tag">'+b.cat+'<span ng-click=remove("'+b._id+'",$event)   class="remove"> x </span></span>')(a),o.append($el)):(t.push(b),s>0?(s++,angular.element(document.querySelector("span#notAddedTags")).html(" "+s+" more selected")):(s++,o.append('<span id="notAddedTags"> '+s+" more selected</span>"))),a.title=""):(a.selectedObjectArray[0]&&a.cats.push(a.selectedObjectArray[0]),a.selectedObjectArray[0]=b,a.title=b.cat),a.cats.forEach(function(c,d){return c._id===b._id&&c.cat===b.cat?void a.cats.splice(d,1):void 0})},e.preselected&&(isNaN(e.preselected)?a.cats.forEach(function(b,c){return b._id===e.preselected||b.cat===e.preselected?void a.addItem(b):void 0}):a.addItem(a.cats[e.preselected])),a.search=function(b){if(32!=b.keyCode){var c=a.q.trim();if(""==c)return void(a.options&&(a.cats=j(m,c,k)));if(40==b.keyCode){angular.element(document.querySelector("ul.resultlist"))}else a.options||i?a.cats=j(m,c,k):f(c,a,!0)}},a.apiAddress&&a.initialSearchApi&&f(a.initialSearchApi,a,!1)}],restrict:"E",templateUrl:"app/views/components/selectbox.html",replace:!0,link:function(a,b,c){b.bind("click",function(){b[0].querySelector("input#selectboxinput").focus()})}}}])});